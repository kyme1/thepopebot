name: Publish to npm

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    concurrency:
      group: npm-publish
      cancel-in-progress: false
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - run: npm ci

      - name: Detect release channel
        id: channel
        run: |
          TAG=$(node -p "
            const v = require('./package.json').version;
            const pre = v.split('-')[1];
            pre ? pre.replace(/[^a-zA-Z].*/g, '') || 'pre' : 'latest'
          ")
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Publishing $(node -p "require('./package.json').version") to dist-tag: $TAG"

      - run: npm publish --tag ${{ steps.channel.outputs.tag }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Generate changelog with LLM
        env:
          GH_TOKEN: ${{ github.token }}
          API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
          MODEL: ${{ vars.ANTHROPIC_SMALL_FAST_MODEL || vars.ANTHROPIC_MODEL }}
        run: |
          CURRENT_TAG=${GITHUB_REF#refs/tags/}

          # For stable releases, compare against previous stable (not beta).
          # For beta releases, compare against the most recent previous release of any kind.
          if echo "$CURRENT_TAG" | grep -q '-'; then
            PREV_TAG=$(gh release list --limit 100 --json tagName \
              --jq '[.[].tagName | select(. != "'"${CURRENT_TAG}"'")] | first // empty')
          else
            PREV_TAG=$(gh release list --limit 100 --json tagName \
              --jq '[.[].tagName | select(. != "'"${CURRENT_TAG}"'" and (contains("-") | not))] | first // empty')
          fi

          if [ -z "$PREV_TAG" ]; then
            echo "Initial release" > /tmp/release_notes.md
            exit 0
          fi

          # Get diff via GitHub API (no local history needed, works with shallow clone)
          gh api "repos/${{ github.repository }}/compare/${PREV_TAG}...${CURRENT_TAG}" \
            --jq '[.files[] | "--- a/\(.filename)\n+++ b/\(.filename)\n\(.patch // "")"] | join("\n\n")' \
            > /tmp/diff.txt 2>/dev/null

          if [ ! -s /tmp/diff.txt ]; then
            echo "Bug fixes and improvements." > /tmp/release_notes.md
            exit 0
          fi

          # Build prompt
          PROMPT_HEADER="Analyze the following code diff between two releases of an npm package (thepopebot — a framework for creating autonomous AI agents). Write a changelog that:

          1. Describes each meaningful change in terms of **user-facing outcomes** — how the project is actually better
          2. Includes brief technical context for each change
          3. Uses bullet points, grouped by theme if there are many changes
          4. Is concise and scannable
          5. Ignores trivial changes (whitespace, formatting, version bumps)

          Diff:"

          # Use jq --rawfile to safely embed diff in JSON (handles all special chars)
          jq -n \
            --arg header "$PROMPT_HEADER" \
            --rawfile diff /tmp/diff.txt \
            --arg model "$MODEL" \
            '{
              model: $model,
              max_tokens: 2048,
              messages: [{role: "user", content: ($header + "\n" + $diff)}]
            }' > /tmp/request.json

          RESPONSE=$(curl -s "${BASE_URL}/v1/messages" \
            -H "x-api-key: $API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d @/tmp/request.json)

          NOTES=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')

          if [ -z "$NOTES" ]; then
            # Fallback: use commit subjects via GitHub compare API
            gh api "repos/${{ github.repository }}/compare/${PREV_TAG}...${CURRENT_TAG}" \
              --jq '[.commits[].commit.message | split("\n")[0] | select(test("^[0-9]+\\.[0-9]+") | not)] | map("- " + .) | join("\n")' \
              > /tmp/release_notes.md 2>/dev/null
            # If that also fails, use a generic message
            [ -s /tmp/release_notes.md ] || echo "Bug fixes and improvements." > /tmp/release_notes.md
          else
            echo "$NOTES" > /tmp/release_notes.md
          fi

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          PRERELEASE_FLAG=""
          if echo "$TAG" | grep -q '-'; then
            PRERELEASE_FLAG="--prerelease"
          fi
          gh release create "$TAG" $PRERELEASE_FLAG --title "$TAG" --notes-file /tmp/release_notes.md
